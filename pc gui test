@interface ViewController () <UISearchBarDelegate>

@property (nonatomic, strong) UIScrollView *categoryScrollView;
@property (nonatomic, strong) UIScrollView *itemsScrollView;
@property (nonatomic, strong) UILabel *infoLabel;
@property (nonatomic, strong) UISearchBar *searchBar;

@property (nonatomic, strong) NSMutableArray<NSString *> *categories;
@property (nonatomic, strong) NSMutableArray<NSNumber *> *filteredIndexes;

@property (nonatomic, strong) NSString *selectedCategory;
@property (nonatomic, strong) NSString *searchText;

@end

// Example: item structure
typedef struct {
    const char *id;
    int netID;
    const char *name;
    const char *description;
    const char *category;
    int price;
    int value;
    bool isLoot;
    bool isPurchasable;
    bool isUnique;
    bool isDevOnly;
} Item;

// Example list of items
Item items[] = {
    { "item_zipline_gun", 111, "Zipline Gun", "Load it with rope and fire to instantly create a zipline between two points.", "Gadgets", 1499, 22, false, true, false, false },
    { "item_flashlight", 112, "Flashlight", "A bright flashlight to light up dark areas.", "Gadgets", 199, 5, true, true, false, false },
    { "item_medkit", 113, "Medkit", "Restores health when used.", "Consumables", 299, 10, true, true, false, false },
    { "item_energy_drink", 114, "Energy Drink", "Boosts stamina temporarily.", "Consumables", 149, 3, true, true, false, false },
    { "item_grappling_hook", 115, "Grappling Hook", "Use it to reach high places.", "Gadgets", 899, 15, false, true, false, false }
};
int itemsCount = sizeof(items)/sizeof(Item);

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.view.backgroundColor = [UIColor darkGrayColor];
    
    // Title
    UILabel *titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 50, self.view.frame.size.width, 50)];
    titleLabel.text = @"The Honored One";
    titleLabel.textColor = [UIColor colorWithRed:0.53 green:0.81 blue:0.98 alpha:1.0];
    titleLabel.textAlignment = NSTextAlignmentCenter;
    titleLabel.font = [UIFont boldSystemFontOfSize:32];
    [self.view addSubview:titleLabel];
    
    // Extract categories
    [self extractCategories];
    
    // Category Scroll (Horizontal)
    self.categoryScrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 110, self.view.frame.size.width, 50)];
    [self.view addSubview:self.categoryScrollView];
    [self buildCategoryButtons];
    
    // Search Bar
    self.searchBar = [[UISearchBar alloc] initWithFrame:CGRectMake(20, 170, self.view.frame.size.width - 40, 40)];
    self.searchBar.delegate = self;
    self.searchBar.placeholder = @"Search items...";
    [self.view addSubview:self.searchBar];
    
    // Info Label at the bottom
    CGFloat infoHeight = 200;
    self.infoLabel = [[UILabel alloc] initWithFrame:CGRectMake(20, self.view.frame.size.height - infoHeight, self.view.frame.size.width - 40, infoHeight)];
    self.infoLabel.textColor = [UIColor whiteColor];
    self.infoLabel.numberOfLines = 0;
    [self.view addSubview:self.infoLabel];
    
    // Items Scroll (Vertical) â€“ dynamic height
    CGFloat itemsY = CGRectGetMaxY(self.searchBar.frame) + 10;
    CGFloat itemsHeight = CGRectGetMinY(self.infoLabel.frame) - itemsY - 10;
    self.itemsScrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(20, itemsY, self.view.frame.size.width - 40, itemsHeight)];
    self.itemsScrollView.backgroundColor = [UIColor colorWithWhite:0.2 alpha:1.0];
    self.itemsScrollView.contentInset = UIEdgeInsetsMake(0, 0, 10, 0);
    [self.view addSubview:self.itemsScrollView];
    
    // Initialize default filter & search
    self.selectedCategory = @"All";
    self.searchText = @"";
    [self applyFilters];
}

#pragma mark - Category Setup

- (void)extractCategories {
    self.categories = [NSMutableArray array];
    [self.categories addObject:@"All"];
    
    for (int i = 0; i < items.size(); i++) {
        NSString *cat = [NSString stringWithUTF8String:items[i].category.c_str()];
        if (![self.categories containsObject:cat]) {
            [self.categories addObject:cat];
        }
    }
}

- (void)buildCategoryButtons {
    CGFloat xOffset = 10;
    
    for (int i = 0; i < self.categories.count; i++) {
        UIButton *button = [UIButton buttonWithType:UIButtonTypeSystem];
        button.frame = CGRectMake(xOffset, 5, 120, 40);
        [button setTitle:self.categories[i] forState:UIControlStateNormal];
        [button setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
        button.backgroundColor = [UIColor colorWithRed:0.53 green:0.81 blue:0.98 alpha:1.0];
        button.layer.cornerRadius = 8;
        button.tag = i;
        
        [button addTarget:self
                   action:@selector(categoryTapped:)
         forControlEvents:UIControlEventTouchUpInside];
        
        [self.categoryScrollView addSubview:button];
        xOffset += 130;
    }
    
    self.categoryScrollView.contentSize = CGSizeMake(xOffset, 50);
}

#pragma mark - Filtering Logic

- (void)categoryTapped:(UIButton *)sender {
    self.selectedCategory = self.categories[sender.tag];
    [self applyFilters];
}

- (void)applyFilters {
    self.filteredIndexes = [NSMutableArray array];
    
    for (int i = 0; i < items.size(); i++) {
        NSString *itemName = [NSString stringWithUTF8String:items[i].name.c_str()];
        NSString *itemCategory = [NSString stringWithUTF8String:items[i].category.c_str()];
        
        BOOL matchesCategory =
        [self.selectedCategory isEqualToString:@"All"] ||
        [itemCategory isEqualToString:self.selectedCategory];
        
        BOOL matchesSearch =
        self.searchText.length == 0 ||
        [[itemName lowercaseString] containsString:[self.searchText lowercaseString]];
        
        if (matchesCategory && matchesSearch) {
            [self.filteredIndexes addObject:@(i)];
        }
    }
    
    [self rebuildItemButtons];
}

#pragma mark - Build Item Buttons

- (void)rebuildItemButtons {
    for (UIView *subview in self.itemsScrollView.subviews) {
        [subview removeFromSuperview];
    }
    
    CGFloat buttonHeight = 50;
    CGFloat spacing = 10;
    
    for (int i = 0; i < self.filteredIndexes.count; i++) {
        int itemIndex = [self.filteredIndexes[i] intValue];
        
        UIButton *button = [UIButton buttonWithType:UIButtonTypeSystem];
        button.frame = CGRectMake(0,
                                  i * (buttonHeight + spacing),
                                  self.itemsScrollView.frame.size.width,
                                  buttonHeight);
        
        [button setTitle:[NSString stringWithUTF8String:items[itemIndex].name.c_str()]
                forState:UIControlStateNormal];
        
        [button setTitleColor:[UIColor yellowColor] forState:UIControlStateNormal];
        button.backgroundColor = [UIColor blackColor];
        button.layer.cornerRadius = 8;
        button.tag = itemIndex;
        
        [button addTarget:self
                   action:@selector(itemButtonTapped:)
         forControlEvents:UIControlEventTouchUpInside];
        
        [self.itemsScrollView addSubview:button];
    }
    
    self.itemsScrollView.contentSize = CGSizeMake(self.itemsScrollView.frame.size.width,
                                                  self.filteredIndexes.count * (buttonHeight + spacing));
}

#pragma mark - Search

- (void)searchBar:(UISearchBar *)searchBar textDidChange:(NSString *)searchText {
    self.searchText = searchText;
    [self applyFilters];
}

- (void)searchBarSearchButtonClicked:(UISearchBar *)searchBar {
    [searchBar resignFirstResponder];
}

@end
